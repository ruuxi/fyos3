#!/usr/bin/env node
// Generate binary snapshot from templates/webcontainer/ using @webcontainer/snapshot

import fs from 'node:fs';
import fsp from 'node:fs/promises';
import path from 'node:path';
import { fileURLToPath } from 'node:url';
import { snapshot } from '@webcontainer/snapshot';

const __filename = fileURLToPath(import.meta.url);
const __dirname = path.dirname(__filename);
const repoRoot = path.resolve(__dirname, '..');

const TEMPLATES_DIR = path.join(repoRoot, 'templates', 'webcontainer');
const SNAPSHOT_FILE = path.join(repoRoot, 'src', 'data', 'webcontainer-snapshot.bin');
const SNAPSHOT_TS_FILE = path.join(repoRoot, 'src', 'utils', 'webcontainer-snapshot.ts');

async function generateSnapshot() {
  if (!fs.existsSync(TEMPLATES_DIR)) {
    console.error(`Templates directory not found: ${path.relative(repoRoot, TEMPLATES_DIR)}`);
    process.exit(1);
  }

  console.log('ğŸ“¦ Generating binary snapshot from templates...');
  
  try {
    // Generate binary snapshot from the templates directory
    const snapshotBuffer = await snapshot(TEMPLATES_DIR);
    
    // Ensure data directory exists
    await fsp.mkdir(path.dirname(SNAPSHOT_FILE), { recursive: true });
    
    // Write binary snapshot
    await fsp.writeFile(SNAPSHOT_FILE, snapshotBuffer);
    console.log(`âœ… Generated binary snapshot: ${path.relative(repoRoot, SNAPSHOT_FILE)} (${(snapshotBuffer.length / 1024).toFixed(1)}KB)`);
    
    // Update the TypeScript utility to use the snapshot
    const tsContent = `// Auto-generated by scripts/generate-webcontainer-snapshot.mjs
import { readFileSync } from 'node:fs';
import path from 'node:path';

/**
 * Get the binary WebContainer snapshot
 * This provides faster mounting than the tree-based approach
 */
export function getSnapshot(): Uint8Array {
  const snapshotPath = path.join(process.cwd(), 'src', 'data', 'webcontainer-snapshot.bin');
  return readFileSync(snapshotPath);
}

/**
 * Legacy function - kept for compatibility
 * @deprecated Use getSnapshot() for better performance
 */
export function getFiles() {
  // For development, we can still fall back to the tree-based approach
  // but in production, prefer using the binary snapshot
  throw new Error('Use getSnapshot() instead for better performance');
}
`;
    
    await fsp.writeFile(SNAPSHOT_TS_FILE, tsContent, 'utf8');
    console.log(`âœ… Updated utility: ${path.relative(repoRoot, SNAPSHOT_TS_FILE)}`);
    
    console.log('ğŸš€ Binary snapshot generation complete!');
    console.log('   WebContainer mounting will now be significantly faster.');
    
  } catch (error) {
    console.error('âŒ Error generating snapshot:', error.message);
    process.exit(1);
  }
}

generateSnapshot().catch((err) => {
  console.error('âŒ Fatal error:', err);
  process.exit(1);
});
