#!/usr/bin/env node
// Generate src/data/webcontainer-files.ts from templates/webcontainer/

import fs from 'node:fs';
import fsp from 'node:fs/promises';
import path from 'node:path';
import { fileURLToPath } from 'node:url';

const __filename = fileURLToPath(import.meta.url);
const __dirname = path.dirname(__filename);
const repoRoot = path.resolve(__dirname, '..');

const TEMPLATES_DIR = path.join(repoRoot, 'templates', 'webcontainer');
const OUT_FILE = path.join(repoRoot, 'src', 'data', 'webcontainer-files.ts');

async function readDirRecursive(dir) {
  const entries = await fsp.readdir(dir, { withFileTypes: true });
  const result = {};
  for (const entry of entries) {
    const fullPath = path.join(dir, entry.name);
    if (entry.isDirectory()) {
      result[entry.name] = { directory: await readDirRecursive(fullPath) };
    } else if (entry.isFile()) {
      const contents = await fsp.readFile(fullPath, 'utf8');
      result[entry.name] = { file: { contents } };
    }
  }
  return result;
}

function emitTs(treeObj) {
  const serialize = (obj, indent = 2) => {
    if (obj && typeof obj === 'object' && 'file' in obj) {
      return `{ file: { contents: ${JSON.stringify(obj.file.contents)} } }`;
    }
    if (obj && typeof obj === 'object' && 'directory' in obj) {
      return `{ directory: ${serialize(obj.directory, indent)} }`;
    }
    if (obj && typeof obj === 'object') {
      const entries = Object.entries(obj)
        .map(([k, v]) => `${JSON.stringify(k)}: ${serialize(v, indent + 2)}`)
        .join(',\n' + ' '.repeat(indent));
      return `{
${' '.repeat(indent)}${entries}
${' '.repeat(indent - 2)}}`;
    }
    return JSON.stringify(obj);
  };

  return `import type { FileSystemTree } from '@webcontainer/api';

// Auto-generated by scripts/generate-webcontainer-files.mjs
export const files: FileSystemTree = ${serialize(treeObj)};
`;
}

async function main() {
  if (!fs.existsSync(TEMPLATES_DIR)) {
    console.error(`Templates directory not found: ${path.relative(repoRoot, TEMPLATES_DIR)}`);
    process.exit(1);
  }
  const tree = await readDirRecursive(TEMPLATES_DIR);
  const ts = emitTs(tree);
  await fsp.writeFile(OUT_FILE, ts, 'utf8');
  console.log(`Wrote ${path.relative(repoRoot, OUT_FILE)} from templates.`);
}

main().catch((err) => {
  console.error(err);
  process.exit(1);
});

